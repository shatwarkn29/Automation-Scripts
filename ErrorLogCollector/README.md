# Automation Scripts for FrontDoor WAF Error Analysis

This repository provides a automation script (IP-error-list-fetch.ps1) designed to streamline the process of collecting and analyzing error logs generated by your Azure FrontDoor Web Application Firewall (WAF).

This script collects FrontDoor WAF error logs based on your specified query, stores the results in a CSV file, and sends the file as an email attachment.


## Key Features:

* **Automated Error Collection** : Script execution automates the retrieval of error logs based on your customized query, saving you time and effort.

* **Customizable Query** : Tailor the query within IP-error-list-fetch.ps1 to match your specific requirements.

* **CSV Output**: Error log data is exported to a CSV file for further analysis or storage.

* **Actionable Insights** : Analyze error logs to identify blocked requests, malicious IP addresses, and potential security concerns.

* **Email Notifications** (Optional): Integrate email alerts using the provided example or your preferred method. If you are this method then using this script you can send the mail to multiple peoples by including their mail address in RecipientEmail seperated by commas (`,`). 

## Prerequisites:

* **Azure Subscription**: You'll need an active Azure subscription to access the relevant resources.
FrontDoor Setup and WAF Policy: Ensure you have a functioning FrontDoor configuration with a WAF policy in place.

* **PowerShell Modules**: Install the required PowerShell modules (AzureCli, Az).

* **Resource Details**: Obtain the following information from your FrontDoor setup:

    Subscription ID
    Resource Group Name
    Resource Name
    Workspace Name
    Workspace ID
    Additional Requirements (for Email Notifications)

* **SendGrid Account**: Create a SendGrid account if you wish to send email notifications using their API.

* **SendGrid API Key**: Obtain your API key from SendGrid (replace **AzEu2Reziai-SendGridAPIkey** in the script with your actual key).

## Example Queries:

The provided examples showcase how to construct queries for analyzing blocked requests:

* **Targeted Time Frame**: This query focuses on a specific date range (August 06, 2024, 9:00 AM - August 7, 2024, 9:00 AM UTC). It filters logs based on FrontDoorWebApplicationFirewallLog category, Block or AnomalyScoring action, and the specified time window. The results are then grouped and sorted by request URI, host, and client IP address (descending order by count).

        AzureDiagnostics 
        | where Category == 'FrontDoorWebApplicationFirewallLog' or Category == 'FrontdoorWebApplicationFirewallLog' 
        | where action_s == 'Block' or action_s == 'AnomalyScoring' 
        | where TimeGenerated between(datetime('2024-08-06T09:00:00.000Z') .. datetime('2024-08-07T09:00:00.000Z')) 
        | project TimeGenerated, requestUri_s, clientIP_s, action_s, host_s 
        | summarize count() by requestUri_s, host_s ,clientIP_s 
        | order by count_ desc

* **Past Day Analysis**: This query retrieves logs related to blocked requests from the past day. It provides similar filtering and aggregation to the first example.
Customization:


        AzureDiagnostics 
        | where Category == 'FrontDoorWebApplicationFirewallLog' or Category == 'FrontdoorWebApplicationFirewallLog' 
        | where action_s == 'Block'
        | where TimeGenerated > ago(1d) 
        | project TimeGenerated, requestUri_s, clientIP_s, action_s, host_s 
        | summarize count() by requestUri_s, host_s ,clientIP_s 
        | order by count_ desc



## Usage
* Save the script as IP-error-list-fetch.ps1.
* Run the script with the necessary parameters:
 
        .\IP-error-list-fetch.ps1. -SubscriptionId "your_subscription_id" -ResourceGroupName "your_resource_group_name" -Resource "your_resource" -WorkspaceName "your_workspace_name" -WorkspaceId "your_workspace_id" -senderEmail "your_sender_email" -recipientEmail "recipient_email1,recipient_email2"
